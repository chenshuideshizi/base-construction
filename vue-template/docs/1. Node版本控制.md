# Node 版本控制方案

口头约定的node版本并不能保证所有人在所有时间都能遵守规则，但用代码控制不一样，像一个毫无情分可言的杀手，发现可乘之机立即结束进程，干净利落(有点中二)。

**什么是依赖地狱**

通俗而言，“依赖地狱”指开发者安装某个软件包时，发现这个软件包里又依赖不同特定版本的其它软件包。随着系统功能越来越复杂，依赖的软件包越来越多，依赖关系也越来越深，这个时候可能面临版本控制被锁死的风险。

### 方案

#### 方案一 使用 Semver

**Step1** 创建 checkVersion 文件

```js
const semver = require('semver')
const { engines } = require('../package.json')

const version = engines.node
if (!semver.satisfies(process.version, version)) {
  console.error(`Node 版本必须是 ${version}, 当前版本为 ${process.version}`)
  process.exit(1)
}
```


**Step2** 在package.json 根节点下的 engines 定义版本号

```js
{
  //...
  "engines": {
    "node": "~17.2.0"
  }
  //...
}
```

- ~ 表示不改变大版本号和次要版本号
- ^ 表示不改变大版本号

**Step3** 在 package.json 根节点下的 scripts 添加脚本

```js
{
  //...
  "scripts": {
    "postinstall": "node ./checkVersion.js"
  }
  //...
}
```

- 由于semver需要在安装后运行，因此在package.json scripts下的 postinstall (不应在preinstall hook下)添加
- 完成后执行node install 当系统node version与指定环境不一致时会结束进程并给予提示

**缺点**

- 如果在 postinstall 中添加 Node 版本检查，
<br>因为需要安装完成后才能检查版本 Node 版本号，需有些依赖包（比如node-sass）会因为版本问题一直下载不下来
- 如果在 preinstall 中添加 Node 版本检查,
<br>因为 semver 还同有安装所以会报错

参考: 控制node版本 https://blog.csdn.net/u010464354/article/details/102983120

#### 方案二 使用 .npmrc 文件做 Node 版本切换

参考: FE.BASE-进一步NodeJS版本管理与自动切换:engineStrict二三事 https://segmentfault.com/a/1190000021636705

使用 nvm 进行 node 版本白之人

**参考资料**

1. 阮一峰 npm scripts 使用指南 http://www.ruanyifeng.com/blog/2016/10/npm_scripts.html

2. 腾讯IVWEB团队的工程化解决方案 https://gitee.com/IVWEB/feflow-cli

3. semver 官方介绍 https://www.npmjs.cn/misc/semver/

4. npm-scripts 官方介绍  https://www.npmjs.cn/misc/scripts/